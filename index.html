<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frank Powell Live - SmartSync v11.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700;900&family=Prata&display=swap" rel="stylesheet">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, setDoc, deleteDoc, doc, onSnapshot, query, orderBy, getDocs, where, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyB6wqnpGAVEoBfcLkb3QRNP6UoLpZxlS64",
            authDomain: "frankpowellmusic.firebaseapp.com",
            projectId: "frankpowellmusic",
            storageBucket: "frankpowellmusic.firebasestorage.app",
            messagingSenderId: "916292842824",
            appId: "1:916292842824:web:44107af0fef411989fef7d"
        };

        // --- APP STATE ---
        const state = {
            user: null,
            db: null,
            auth: null,
            cloudGigs: [],     // Source of Truth (Green)
            localGigs: [],     // Pending Uploads (Amber)
            isSyncing: false,
            unsubscribe: null, // Listener reference
            appId: "default"   // Used for Firestore path structure
        };

        // --- INITIALIZATION ---
        async function initApp() {
            try {
                // 1. PRIORITY: Load & Render Local Cache Immediately (Optimistic UI)
                loadLocalStorage();
                renderUnifiedInterface();

                // 2. Initialize Firebase
                const app = initializeApp(firebaseConfig);
                state.auth = getAuth(app);
                state.db = getFirestore(app);

                // 3. Setup Auth Listener
                onAuthStateChanged(state.auth, (user) => {
                    if (user) {
                        state.user = user;
                        updateStatus("Syncing Cloud...", "text-blue-400 animate-pulse");
                        setupFirestoreListener();
                    } else {
                        state.user = null;
                        signInAnonymously(state.auth).catch(e => {
                            console.error("Auth Failed", e);
                            updateStatus("Auth Error", "text-red-500");
                        });
                    }
                });

            } catch (e) {
                console.error("Init failed:", e);
                updateStatus("System Error", "text-red-500");
            }
        }

        // --- DATA MANAGEMENT ---

        function loadLocalStorage() {
            try {
                const stored = localStorage.getItem('frankPowellPending');
                state.localGigs = stored ? JSON.parse(stored) : [];
            } catch (e) {
                console.error("Local Storage Error", e);
                state.localGigs = [];
            }
        }

        function saveLocalStorage() {
            localStorage.setItem('frankPowellPending', JSON.stringify(state.localGigs));
        }

        // --- FIRESTORE LOGIC ---

        function setupFirestoreListener() {
            if (!state.user || !state.db) return;
            
            // Avoid duplicate listeners
            if (state.unsubscribe) state.unsubscribe();

            const toursRef = collection(state.db, 'artifacts', firebaseConfig.appId, 'public', 'data', 'tours');
            
            state.unsubscribe = onSnapshot(toursRef, (snapshot) => {
                const fetched = [];
                snapshot.forEach(doc => {
                    fetched.push({ firebaseId: doc.id, ...doc.data() });
                });

                state.cloudGigs = fetched;
                
                // IMPORTANT: The Cloud is the boss. If it's in the cloud, remove from local.
                cleanLocalDuplicates(); 
                
                updateStatus("Cloud Online", "text-green-400");
                renderUnifiedInterface();

                // Try to sync any remaining local items
                if(state.localGigs.length > 0 && navigator.onLine) {
                    runSmartSync();
                }

            }, (error) => {
                console.error("Listener Error:", error);
                updateStatus("Offline / Permission Error", "text-amber-500");
            });
        }

        // --- THE INTELLIGENT SYNC ENGINE (ROBUST V2) ---

        async function runSmartSync() {
            if (state.isSyncing || state.localGigs.length === 0 || !state.user) return;

            state.isSyncing = true;
            updateSyncStatus("Syncing...", "text-blue-400 animate-pulse");

            let syncCount = 0;
            let errorCount = 0;

            // Clone queue to avoid mutation issues during iteration
            const currentQueue = [...state.localGigs];

            for (const gig of currentQueue) {
                // ROBUST CHECK: Matches by ID, not string content
                const alreadyInCloud = state.cloudGigs.some(c => c.firebaseId === gig.localId);

                if (alreadyInCloud) {
                    continue; 
                }

                try {
                    // Prepare Payload
                    const docPayload = { ...gig };
                    delete docPayload.localId; // Remove internal ID field (it becomes the key)

                    // IDEMPOTENT UPLOAD: Use setDoc with the specific localId
                    const docRef = doc(state.db, 'artifacts', firebaseConfig.appId, 'public', 'data', 'tours', gig.localId);
                    await setDoc(docRef, docPayload, { merge: true });
                    
                    syncCount++;
                    // We rely on the Listener (onSnapshot) -> cleanLocalDuplicates to remove it from state
                } catch (e) {
                    console.error("Upload failed for gig:", gig.venue, e);
                    errorCount++;
                }
            }

            state.isSyncing = false;
            
            if (syncCount > 0) {
                updateSyncStatus(`Synced ${syncCount} items`, "text-green-400");
                setTimeout(() => updateSyncStatus("Smart Sync Active", "text-gray-500"), 3000);
            } else if (errorCount > 0) {
                updateSyncStatus(`Sync Error (${errorCount})`, "text-red-500");
            } else {
                updateSyncStatus("Sync Complete", "text-gray-500");
            }
        }

        function cleanLocalDuplicates() {
            // Filter state.localGigs: Keep only items where ID is NOT in cloud
            const initialCount = state.localGigs.length;

            state.localGigs = state.localGigs.filter(local => {
                const match = state.cloudGigs.some(cloud => cloud.firebaseId === local.localId);
                return !match; // Keep if NO match
            });

            if (state.localGigs.length !== initialCount) {
                saveLocalStorage();
                console.log(`Cleaned ${initialCount - state.localGigs.length} synced items from local storage.`);
                renderUnifiedInterface();
            }
        }

        // --- ACTIONS ---

        window.addNewGig = async () => {
            const inputs = getInputs();
            if(!inputs.date.value || !inputs.venue.value) return alert("Date and Venue are required.");

            // Format Time
            let timeStr = "TBA";
            if (inputs.startTime.value && inputs.endTime.value) timeStr = `${inputs.startTime.value} - ${inputs.endTime.value} PM`;
            else if (inputs.startTime.value) timeStr = `${inputs.startTime.value} PM`;

            const newGig = {
                localId: 'loc_' + Date.now() + Math.random().toString(36).substr(2, 5),
                date: inputs.date.value,
                time: timeStr,
                venue: inputs.venue.value.toUpperCase(),
                city: inputs.cityState.value.toUpperCase(),
                note: inputs.note.value.toUpperCase(),
                createdAt: new Date().toISOString(),
                type: inputs.showType.value
            };

            // 1. Save to Local (Optimistic)
            state.localGigs.push(newGig);
            saveLocalStorage();

            // 2. Clear Inputs
            inputs.venue.value = ""; 
            inputs.cityState.value = ""; 
            inputs.note.value = "";

            // 3. Render
            renderUnifiedInterface();
            window.switchTab('tour');

            // 4. Trigger Sync (Debounced)
            if (navigator.onLine && state.user) {
                if (window.syncTimer) clearTimeout(window.syncTimer);
                window.syncTimer = setTimeout(() => {
                    runSmartSync();
                }, 2000); // 2 second delay to bundle edits or prevent rapid-fire
            } else {
                updateSyncStatus("Saved Offline", "text-amber-500");
            }
        };

        window.deleteGig = async (id, isLocal) => {
            if(!confirm("Are you sure you want to delete this gig?")) return;

            if (isLocal) {
                // Remove from Local Storage
                state.localGigs = state.localGigs.filter(g => g.localId !== id);
                saveLocalStorage();
                renderUnifiedInterface();
            } else {
                // Remove from Cloud
                if (!state.user || !navigator.onLine) return alert("Must be online to delete cloud items.");
                
                try {
                    const docRef = doc(state.db, 'artifacts', firebaseConfig.appId, 'public', 'data', 'tours', id);
                    await deleteDoc(docRef);
                    // No need to render manually, the listener will do it
                } catch(e) {
                    console.error(e);
                    alert("Delete failed: " + e.message);
                }
            }
        };

        window.manualSync = () => {
            if(!navigator.onLine) return alert("You are offline.");
            if(!state.user) {
                // Try to reconnect auth
                signInAnonymously(state.auth);
                return updateStatus("Reconnecting...", "text-blue-400");
            }
            setupFirestoreListener(); // Refresh listener
            runSmartSync(); // Push data
        };

        // --- RENDER LOGIC ---

        function renderUnifiedInterface() {
            // Merge Cloud and Local for display
            // We tag them with 'source' to show different colored dots
            const mergedList = [
                ...state.cloudGigs.map(g => ({...g, source: 'cloud'})),
                ...state.localGigs.map(g => ({...g, source: 'local'}))
            ];

            // Sort by Date
            mergedList.sort((a,b) => new Date(a.date) - new Date(b.date));

            // Update Global for Poster Canvas
            window.currentTourData = mergedList;
            
            // Render Sidebar List
            const sb = document.getElementById('tourListContainer');
            sb.innerHTML = '';
            
            if(mergedList.length === 0) {
                sb.innerHTML = '<div class="text-center mt-10 text-gray-400 text-xs italic">No gigs scheduled.</div>';
            }

            const today = new Date(); today.setHours(0,0,0,0);

            mergedList.forEach(gig => {
                const dt = new Date(gig.date + 'T00:00:00');
                const isPast = dt < today;
                const isLocal = gig.source === 'local';
                const dateStr = dt.toLocaleDateString('en-US', {month:'short', day:'numeric'}).toUpperCase();
                
                // Indicators
                let statusDot = isLocal ? 
                    `<span class="h-2 w-2 rounded-full bg-amber-500 animate-pulse mr-2" title="Waiting to Sync"></span>` :
                    `<span class="h-2 w-2 rounded-full bg-green-500 mr-2" title="Synced to Cloud"></span>`;

                sb.innerHTML += `
                    <div class="flex justify-between items-center bg-gray-50 p-2 border-l-4 ${isLocal ? 'border-amber-400' : 'border-green-500'} rounded shadow-sm text-xs mb-2 ${isPast ? 'opacity-50' : ''}">
                        <div class="overflow-hidden w-full">
                            <div class="flex items-center mb-1">
                                ${statusDot}
                                <span class="font-bold text-gray-800">${dateStr}</span>
                                <span class="text-gray-500 text-[10px] ml-auto font-mono">${gig.time}</span>
                            </div>
                            <div class="text-gray-600 truncate font-bold">${gig.venue}</div>
                            <div class="text-gray-400 truncate text-[10px]">${gig.city}</div>
                        </div>
                        <button onclick="deleteGig('${isLocal ? gig.localId : gig.firebaseId}', ${isLocal})" class="text-gray-300 hover:text-red-500 ml-2 p-2 transition-colors">
                            &times;
                        </button>
                    </div>`;
            });

            // Trigger Canvas Update
            window.dispatchEvent(new CustomEvent('gigsUpdated'));
            
            // Update counts in UI
            if (state.localGigs.length > 0) updateSyncStatus(`Pending: ${state.localGigs.length}`, "text-amber-500");
        }

        // --- HELPERS ---
        function getInputs() {
            return {
                showType: document.getElementById('inputShowType'),
                date: document.getElementById('inputDate'),
                startTime: document.getElementById('inputStartTime'),
                endTime: document.getElementById('inputEndTime'),
                venue: document.getElementById('inputVenue'),
                cityState: document.getElementById('inputCityState'),
                note: document.getElementById('inputNote')
            };
        }

        function updateStatus(text, colorClass) {
            const el = document.getElementById('cloudStatus');
            if(el) {
                el.innerText = text;
                el.className = `px-3 py-2 bg-zinc-900/90 rounded-full text-[10px] font-bold uppercase tracking-widest shadow-lg border border-zinc-700 backdrop-blur-md transition-colors duration-300 ${colorClass}`;
            }
        }

        function updateSyncStatus(text, colorClass) {
            const el = document.getElementById('syncStatus');
            if(el) {
                el.innerText = text;
                el.className = `px-3 py-2 bg-zinc-900/90 rounded-full text-[10px] font-bold uppercase tracking-widest shadow-lg border border-zinc-700 backdrop-blur-md transition-colors duration-300 ${colorClass}`;
            }
        }

        // --- NETWORK EVENTS ---
        window.addEventListener('online', () => {
            updateStatus("Back Online", "text-blue-400");
            if(state.user) {
                setupFirestoreListener();
                runSmartSync();
            } else {
                signInAnonymously(state.auth);
            }
        });

        window.addEventListener('offline', () => {
            updateStatus("Offline Mode", "text-amber-500");
        });

        // Start
        initApp();

    </script>

    <style>
        :root { --color-bg: #0f0f0f; --color-text-main: #f3f4f6; --color-accent: #fbbf24; --color-accent-dark: #b38728; }
        body { font-family: 'Montserrat', sans-serif; background-color: #e5e7eb; }
        .poster-canvas { width: 1080px; height: 1350px; background-color: var(--color-bg); color: var(--color-text-main); position: relative; overflow: hidden; display: flex; flex-direction: column; box-sizing: border-box; transform-origin: top center; }
        .texture-bg { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.05; pointer-events: none; z-index: 0; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E"); }
        .font-serif-title { font-family: 'Prata', serif; }
        .gold-text-solid { color: var(--color-accent); text-shadow: 1px 1px 0 var(--color-accent-dark), 2px 2px 0 #78350f, 0 0 20px rgba(251, 191, 36, 0.3); }
        .bg-accent { background-color: var(--color-accent-dark); }
        .border-accent { border-color: var(--color-accent-dark); }
        .text-accent { color: #fcf6ba; }
        .past-gig-row { opacity: 0.5; }
        .past-gig-text { text-decoration: line-through; text-decoration-color: var(--color-accent-dark); text-decoration-thickness: 3px; }
        #poster-canvas { align-items: center; justify-content: space-between; padding: 110px 70px; }
        #tour-canvas { align-items: center; justify-content: flex-start; padding: 50px 60px 40px 60px; }
        .border-line { position: absolute; left: 40px; right: 40px; top: 40px; bottom: 40px; border: 2px solid rgba(251, 191, 36, 0.2); pointer-events: none; z-index: 10; }
        .corner-accent { position: absolute; width: 120px; height: 120px; z-index: 20; border-color: var(--color-accent-dark); border-style: solid; border-width: 0; }
        .tl { top: 40px; left: 40px; border-top-width: 6px; border-left-width: 6px; }
        .tr { top: 40px; right: 40px; border-top-width: 6px; border-right-width: 6px; }
        .bl { bottom: 40px; left: 40px; border-bottom-width: 6px; border-left-width: 6px; }
        .br { bottom: 40px; right: 40px; border-bottom-width: 6px; border-right-width: 6px; }
        input:focus, select:focus { outline: none; border-color: var(--color-accent); box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.2); }
        .tab-btn.active { background-color: #1f2937; color: var(--color-accent); border-bottom: 2px solid var(--color-accent); }
        .tab-btn { background-color: #374151; color: #9ca3af; }
        .fab-btn { width: 3.5rem; height: 3.5rem; border-radius: 9999px; background-color: white; color: #111827; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); transition: all 0.15s; border: 1px solid #d1d5db; cursor: pointer; }
        .fab-btn:hover { background-color: #e5e7eb; }
        .fab-btn:active { transform: scale(0.95); }
        .fab-btn:disabled { background-color: #6b7280; cursor: not-allowed; opacity: 0.7; transform: none; }
        /* Scrollbar styles for the sidebar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
    </style>
</head>
<body class="min-h-screen flex flex-col-reverse lg:flex-row">

    <div class="w-full lg:w-1/3 bg-white border-r border-gray-200 p-6 lg:p-8 flex flex-col shadow-xl z-30 h-auto lg:h-screen overflow-y-auto relative">
        
        <form id="gigForm" class="space-y-4 mb-6 mt-6">
            <div>
                <label class="block text-xs font-bold text-gray-700 mb-1 uppercase tracking-wide">Show Format</label>
                <select id="inputShowType" class="w-full border-2 border-gray-200 rounded-none px-3 py-3 text-gray-800 bg-gray-50 focus:bg-white font-mono text-sm uppercase">
                    <option value="Live">Solo / Live (Gold)</option>
                    <option value="Duo">Duo (Silver)</option>
                    <option value="Full Band">Full Band (Platinum)</option>
                </select>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-gray-700 mb-1 uppercase tracking-wide">Title Line 1</label>
                    <input type="text" id="inputHeaderLine1" placeholder="FRANK" class="w-full border-2 border-gray-200 rounded-none px-3 py-3 text-gray-800 bg-gray-50 focus:bg-white font-mono text-sm uppercase">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-700 mb-1 uppercase tracking-wide">Title Line 2</label>
                    <input type="text" id="inputHeaderLine2" placeholder="POWELL" class="w-full border-2 border-gray-200 rounded-none px-3 py-3 text-gray-800 bg-gray-50 focus:bg-white font-mono text-sm uppercase">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-gray-700 mb-1 uppercase tracking-wide">Date</label>
                    <input type="date" id="inputDate" class="w-full border-2 border-gray-200 rounded-none px-3 py-3 text-gray-800 bg-gray-50 focus:bg-white font-mono text-sm">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-700 mb-1 uppercase tracking-wide">Time (PM)</label>
                    <div class="flex items-center gap-1">
                        <select id="inputStartTime" class="w-full border-2 border-gray-200 rounded-none px-2 py-3 text-gray-800 bg-gray-50 focus:bg-white font-mono text-sm">
                            <option value="" disabled selected>Start</option>
                        </select>
                        <span class="text-gray-400 font-bold">-</span>
                        <select id="inputEndTime" class="w-full border-2 border-gray-200 rounded-none px-2 py-3 text-gray-800 bg-gray-50 focus:bg-white font-mono text-sm">
                            <option value="" disabled selected>End</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="bg-gray-100 p-4 border border-gray-200 rounded-sm">
                <label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">Saved Venues (Local)</label>
                <div class="flex gap-2 mb-3">
                    <select id="savedVenues" onchange="loadSelectedVenue()" class="w-full border border-gray-300 rounded-none px-2 py-3 text-sm text-gray-700 bg-white">
                        <option value="">Select a venue...</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <button type="button" onclick="saveCurrentVenue()" class="flex-1 bg-gray-600 hover:bg-gray-700 active:scale-95 transform transition-transform text-white text-xs font-bold py-3 px-2 rounded-sm uppercase tracking-wider">Save Venue</button>
                    <button type="button" onclick="deleteCurrentVenue()" class="flex-1 bg-gray-400 hover:bg-red-500 active:scale-95 transform transition-transform text-white text-xs font-bold py-3 px-2 rounded-sm uppercase tracking-wider">Delete</button>
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-700 mb-1 uppercase tracking-wide">Venue Name</label>
                <input type="text" id="inputVenue" placeholder="e.g. The Bluebird Cafe" class="w-full border-2 border-gray-200 rounded-none px-3 py-3 text-gray-800 bg-gray-50 focus:bg-white font-mono text-sm uppercase">
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-700 mb-1 uppercase tracking-wide">City / State</label>
                <input type="text" id="inputCityState" placeholder="e.g. Nashville, TN" class="w-full border-2 border-gray-200 rounded-none px-3 py-3 text-gray-800 bg-gray-50 focus:bg-white font-mono text-sm uppercase">
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-700 mb-1 uppercase tracking-wide">Note / Entry Info</label>
                <input type="text" id="inputNote" placeholder="e.g. Free Entry" class="w-full border-2 border-gray-200 rounded-none px-3 py-3 text-gray-800 bg-gray-50 focus:bg-white font-mono text-sm uppercase">
            </div>

            <div class="flex gap-2 mt-4">
                <button type="button" onclick="window.addNewGig()" class="flex-[3] bg-amber-600 hover:bg-amber-700 active:scale-95 text-white font-bold uppercase tracking-widest py-4 px-4 shadow-sm transition-all text-sm">
                    Add To Calendar
                </button>
                <button type="button" onclick="window.manualSync()" class="flex-1 bg-blue-600 hover:bg-blue-700 active:scale-95 text-white font-bold uppercase tracking-widest py-4 px-1 shadow-sm transition-all text-[10px] flex flex-col items-center justify-center">
                    <span>Force</span><span>Sync</span>
                </button>
            </div>
        </form>

        <div class="flex-grow overflow-y-auto border-t border-gray-200 pt-4 mb-4 min-h-[150px]">
            <div class="flex justify-between items-end mb-3">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Unified Gig Database</h3>
                <div class="flex gap-2">
                    <span class="h-2 w-2 rounded-full bg-green-500" title="Cloud"></span>
                    <span class="h-2 w-2 rounded-full bg-amber-500" title="Pending Upload"></span>
                </div>
            </div>
            <div id="tourListContainer" class="space-y-1">
                <div class="text-center mt-10 text-gray-400 text-xs italic">Connecting to SmartSync...</div>
            </div>
        </div>

        <div class="mt-auto border-t border-gray-100 pt-4 text-center pb-6">
            <h1 class="text-xl font-black text-gray-800 uppercase tracking-widest">Generator <span class="text-amber-500">v11.2</span></h1>
            <p class="text-[9px] text-gray-400 uppercase tracking-wider mt-1">Robust Sync â€¢ Idempotent</p>
        </div>
    </div>

    <div class="w-full h-[65vh] lg:h-auto lg:w-2/3 bg-zinc-800 flex flex-col items-center justify-start relative overflow-hidden shrink-0">
        <div class="w-full flex justify-center z-40 bg-zinc-900 shadow-md">
            <button onclick="switchTab('single')" id="tab-single" class="tab-btn active px-8 py-4 font-bold uppercase tracking-widest text-xs lg:text-sm focus:outline-none flex-1 lg:flex-none">Single Poster</button>
            <button onclick="switchTab('tour')" id="tab-tour" class="tab-btn px-8 py-4 font-bold uppercase tracking-widest text-xs lg:text-sm focus:outline-none flex-1 lg:flex-none">Gig Schedule</button>
        </div>

        <div class="w-full flex-grow flex items-center justify-center p-4 lg:p-10 relative overflow-hidden">
            <div id="preview-scaler" style="transform: scale(0.45);">
                
                <div id="poster-canvas" class="poster-canvas">
                    <div class="texture-bg"></div>
                    <div class="border-line"></div>
                    <div class="corner-accent tl"></div><div class="corner-accent tr"></div><div class="corner-accent bl"></div><div class="corner-accent br"></div>

                    <div id="posterHeader" class="text-center z-20 w-full relative mt-16 flex flex-col items-center transition-all duration-300">
                        <p class="text-xl uppercase tracking-[0.3em] text-accent font-bold mb-4 font-sans">An Evening of Music</p>
                        <p class="text-base uppercase tracking-[0.4em] text-gray-400 font-light mb-8 font-sans">with</p>
                        
                        <svg width="1000" height="250" viewBox="0 0 1000 250" class="mx-auto block" style="overflow: visible;">
                            <defs id="svgDefs1"></defs>
                            <text id="svgTitleLine1" x="50%" y="100" text-anchor="middle" font-family="'Prata', serif" font-weight="900" font-size="110" fill="url(#metallicGradient)" filter="url(#dropShadow)" letter-spacing="10" text-transform="uppercase">FRANK</text>
                            <text id="svgTitleLine2" x="50%" y="220" text-anchor="middle" font-family="'Prata', serif" font-weight="900" font-size="110" fill="url(#metallicGradient)" filter="url(#dropShadow)" letter-spacing="10" text-transform="uppercase">POWELL</text>
                        </svg>
                        
                        <div id="posterLinesContainer" class="flex items-center justify-center gap-6 mt-10">
                            <div class="h-[2px] w-16 bg-accent mt-2"></div>
                            <p id="displayShowTypeText" class="text-4xl italic text-gray-300 font-serif-title tracking-widest text-accent">Live</p>
                            <div class="h-[2px] w-16 bg-accent mt-2"></div>
                        </div>
                    </div>

                    <div id="posterInfoWrapper" class="z-20 w-full flex flex-col items-center justify-center gap-28">
                        <div class="flex flex-col items-center justify-center border-2 border-accent bg-neutral-900/90 py-10 px-12 min-w-[480px] shadow-2xl">
                            <div class="flex flex-col gap-4 items-center">
                                <h2 id="displayDate" class="text-7xl gold-text-solid font-bold tracking-tight font-serif-title text-center leading-normal">OCT 12</h2>
                                <div class="h-1 w-24 bg-accent rounded-full"></div>
                                <h3 id="displayTime" class="text-5xl text-white font-sans font-bold uppercase tracking-widest drop-shadow-md text-center leading-normal">Doors 7:00 PM</h3>
                            </div>
                        </div>
                        <div class="bg-black/80 flex flex-col items-center justify-center py-6 px-12 min-w-[500px] rounded-lg border-t border-accent">
                            <div class="flex flex-col items-center gap-1">
                                <h2 id="displayVenue" class="text-6xl font-bold text-white tracking-wide drop-shadow-md font-serif-title leading-normal text-center">VENUE NAME</h2>
                                <h3 id="displayCityState" class="text-2xl text-gray-400 font-sans uppercase tracking-[0.2em] font-light text-center">CITY, STATE</h3>
                            </div>
                        </div>
                    </div>

                    <div id="posterFooter" class="z-20 text-center w-full">
                         <p id="displayNote" class="text-xl text-accent font-mono uppercase tracking-widest drop-shadow-sm opacity-90">FREE ENTRY</p>
                    </div>
                </div>

                <div id="tour-canvas" class="poster-canvas hidden">
                    <div class="texture-bg"></div>
                    <div class="border-line" style="border-color: rgba(255,255,255,0.1);"></div>
                    
                    <div id="tourHeaderContainer" class="text-center z-20 w-full relative">
                        <svg width="1000" height="90" viewBox="0 0 1000 90" class="mx-auto block" style="overflow: visible;">
                            <text id="svgTourTitle" x="50%" y="80" text-anchor="middle" font-family="'Prata', serif" font-weight="900" font-size="90" fill="url(#metallicGradient)" filter="url(#dropShadow)" letter-spacing="5" text-transform="uppercase">FRANK POWELL</text>
                        </svg>
                        <div class="flex items-center justify-center gap-4 mt-3">
                            <div class="h-[1px] w-12 bg-gray-500"></div>
                            <p class="text-3xl uppercase tracking-[0.3em] text-white font-light font-sans">Upcoming Gig Dates</p>
                            <div class="h-[1px] w-12 bg-gray-500"></div>
                        </div>
                    </div>
                    
                    <div class="flex-grow w-full z-20 flex flex-col justify-center items-center px-8 py-4 overflow-hidden">
                        <div id="tourCanvasList" class="w-full flex flex-col space-y-2 origin-top"></div>
                    </div>
                    
                    <div id="tourFooterContainer" class="z-20 text-center w-full">
                         <p class="text-2xl text-accent font-serif-title italic tracking-widest">frankpowellmusic.net</p>
                    </div>
                </div>
            </div>

            <div class="absolute bottom-6 right-6 flex flex-col gap-3 z-50">
                <button onclick="shareCalendar()" class="fab-btn" title="Share Calendar (.ics)"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg></button>
                <button onclick="shareActivePoster()" class="fab-btn" title="Share Poster Image"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" /></svg></button>
                <button onclick="downloadActivePoster()" class="fab-btn" title="Download Poster Image"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg></button>
            </div>

            <div class="absolute bottom-6 left-6 z-50 pointer-events-none flex flex-col gap-2 items-start">
                <span id="syncStatus" class="px-3 py-2 bg-zinc-900/80 rounded-full text-[10px] font-bold uppercase tracking-widest text-gray-500 shadow-lg border border-zinc-700 backdrop-blur-md transition-colors duration-300">
                    Smart Sync
                </span>
                <span id="cloudStatus" class="px-3 py-2 bg-zinc-900/80 rounded-full text-[10px] font-bold uppercase tracking-widest text-gray-400 shadow-lg border border-zinc-700 backdrop-blur-md transition-colors duration-300">
                    Connecting...
                </span>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIG & STATE ---
        window.currentTourData = []; 
        let currentTab = 'single';
        let debounceTimer;

        const inputs = {
            showType: document.getElementById('inputShowType'),
            headerLine1: document.getElementById('inputHeaderLine1'),
            headerLine2: document.getElementById('inputHeaderLine2'),
            date: document.getElementById('inputDate'),
            startTime: document.getElementById('inputStartTime'),
            endTime: document.getElementById('inputEndTime'),
            venue: document.getElementById('inputVenue'),
            cityState: document.getElementById('inputCityState'),
            note: document.getElementById('inputNote')
        };
        const displays = {
            showTypeText: document.getElementById('displayShowTypeText'),
            date: document.getElementById('displayDate'),
            time: document.getElementById('displayTime'),
            venue: document.getElementById('displayVenue'),
            cityState: document.getElementById('displayCityState'),
            note: document.getElementById('displayNote')
        };
        const svgEls = {
            line1: document.getElementById('svgTitleLine1'),
            line2: document.getElementById('svgTitleLine2'),
            tour: document.getElementById('svgTourTitle'),
            defs: document.getElementById('svgDefs1')
        };
        const venueSelect = document.getElementById('savedVenues');
        const CONFIG = {
            colors: {
                gold: { accent: '#fbbf24', accentDark: '#b38728', shadow: 'rgba(0,0,0,0.5)', gradient: ['#bf953f', '#fcf6ba', '#b38728', '#fbf5b7', '#aa771c'] },
                silver: { accent: '#e5e7eb', accentDark: '#a0a0a0', shadow: 'rgba(0,0,0,0.6)', gradient: ['#a0a0a0', '#e5e7eb', '#c0c0c0', '#dcdcdc', '#909090'] },
                platinum: { accent: '#e5e4e2', accentDark: '#71797e', shadow: 'rgba(0,0,0,0.7)', gradient: ['#ffffff', '#e5e4e2', '#8e99a3', '#c9c9c9', '#ffffff'] }
            }
        };

        // --- 2. LOCAL VENUE MANAGER ---
        function getStore(k) { return JSON.parse(localStorage.getItem(k) || '[]'); }
        function setStore(k, v) { localStorage.setItem(k, JSON.stringify(v)); }

        function loadVenues() {
            const v = getStore('frankPowellVenues');
            venueSelect.innerHTML = '<option value="">Select a venue...</option>';
            v.forEach((item, i) => venueSelect.innerHTML += `<option value="${i}">${item.name} (${item.city})</option>`);
        }

        function saveCurrentVenue() {
            const name = inputs.venue.value.trim().toUpperCase();
            const city = inputs.cityState.value.trim().toUpperCase();
            if (!name) return alert("Enter name.");
            const v = getStore('frankPowellVenues');
            const idx = v.findIndex(x => x.name === name);
            if (idx > -1) v[idx] = {name, city}; else v.push({name, city});
            setStore('frankPowellVenues', v); loadVenues();
        }

        function deleteCurrentVenue() {
            if (venueSelect.value === "") return;
            if(!confirm("Delete venue?")) return;
            const v = getStore('frankPowellVenues');
            v.splice(venueSelect.value, 1);
            setStore('frankPowellVenues', v); loadVenues();
            inputs.venue.value = ""; inputs.cityState.value = "";
            debouncedUpdate();
        }

        function loadSelectedVenue() {
            const v = getStore('frankPowellVenues')[venueSelect.value];
            if (v) { inputs.venue.value = v.name; inputs.cityState.value = v.city; debouncedUpdate(); }
        }

        // --- 4. UI RENDERING (Poster Side) ---
        window.addEventListener('gigsUpdated', renderPosterList);

        function renderPosterList() {
            const dates = window.currentTourData || [];
            const cv = document.getElementById('tourCanvasList');
            cv.innerHTML = '';

            if (dates.length === 0) {
                cv.innerHTML = '<p class="text-white text-center text-3xl font-serif-title mt-20">Coming Soon</p>';
                return;
            }

            const today = new Date(); today.setHours(0,0,0,0);

            // POSTER LOGIC
            const pastDates = dates.filter(d => new Date(d.date+'T00:00:00') < today);
            const futureDates = dates.filter(d => new Date(d.date+'T00:00:00') >= today);
            const visiblePast = pastDates.slice(-2); 
            const visibleFuture = futureDates.slice(0, 7);
            const displayList = [...visiblePast, ...visibleFuture];

            displayList.forEach((d) => {
                const dt = new Date(d.date+'T00:00:00');
                const isPast = dt < today;
                const m = dt.toLocaleDateString('en-US', {month:'short'}).toUpperCase();
                const day = dt.toLocaleDateString('en-US', {day:'numeric'});
                const rowClass = isPast ? 'past-gig-row' : '';
                const textClass = isPast ? 'past-gig-text' : '';
                const venueLength = d.venue.length;
                let venueSize = venueLength > 25 ? "1.4em" : (venueLength > 15 ? "1.8em" : "2.2em");
                let timeSize = d.time.length > 10 ? "1.0em" : (d.time.length > 8 ? "1.2em" : "1.5em");

                cv.innerHTML += `
                    <div class="tour-item-row flex items-center justify-between py-3 border-b border-gray-800 w-full ${rowClass}">
                        <div class="flex items-center gap-10 w-full ${textClass}">
                            <div class="w-32 text-right font-bold text-2em text-white font-serif-title tracking-tight shrink-0 leading-none whitespace-nowrap" style="font-size: 2.5em;">${m} <span class="text-accent">${day}</span></div>
                            <div class="w-48 text-center text-accent font-mono uppercase tracking-widest shrink-0 leading-none whitespace-nowrap" style="font-size: ${timeSize};">${d.time}</div>
                            <div class="flex-grow text-left overflow-hidden" style="padding-bottom: 4px;">
                                <div class="text-gray-200 font-bold uppercase tracking-wide truncate" style="font-size: ${venueSize}; line-height: 1.7; padding-bottom: 0.1em;">${d.venue}</div>
                                <div class="text-gray-500 font-light uppercase tracking-widest leading-none" style="font-size: 1.3em; line-height: 1.5;">${d.city}</div>
                            </div>
                        </div>
                    </div>`;
            });
            setTimeout(fitTourList, 50);
        }

        // --- 5. STANDARD FUNCTIONS ---
        function initTimeOptions() {
            const opts = [];
            for(let i=1; i<=12; i++) opts.push(`<option value="${i}">${i}</option>`);
            const html = opts.join('');
            inputs.startTime.innerHTML = '<option value="" disabled selected>Start</option>' + html;
            inputs.endTime.innerHTML = '<option value="" disabled selected>End</option>' + html;
        }

        function applyTheme(themeName) {
            const theme = CONFIG.colors[themeName];
            const root = document.documentElement;
            root.style.setProperty('--color-accent', theme.accent);
            root.style.setProperty('--color-accent-dark', theme.accentDark);
            const gradientStops = theme.gradient.map((c, i) => {
                const offset = i * (100 / (theme.gradient.length - 1));
                return `<stop offset="${offset}%" style="stop-color:${c};stop-opacity:1" />`;
            }).join('');
            svgEls.defs.innerHTML = `<linearGradient id="metallicGradient" x1="0%" y1="0%" x2="0%" y2="100%">${gradientStops}</linearGradient><filter id="dropShadow"><feDropShadow dx="0" dy="2" stdDeviation="0" flood-color="${theme.shadow}" /></filter>`;
        }

        function updatePoster() {
            const showType = inputs.showType.value;
            applyTheme(showType === 'Duo' ? 'silver' : (showType === 'Full Band' ? 'platinum' : 'gold'));
            const pl = document.getElementById('posterLinesContainer');
            if (pl) pl.style.display = (showType !== 'Duo' && showType !== 'Full Band') ? 'flex' : 'none';
            if (displays.showTypeText) displays.showTypeText.innerText = "Live";

            const dVal = inputs.date.value;
            displays.date.innerText = dVal ? new Date(dVal + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' }).toUpperCase() : "DATE TBA";
            
            const start = inputs.startTime.value;
            const end = inputs.endTime.value;
            if (start && end) displays.time.innerText = `${start} - ${end} PM`;
            else if (start) displays.time.innerText = `${start} PM`;
            else displays.time.innerText = "TIME TBA";

            const venueVal = (inputs.venue.value || "VENUE NAME").toUpperCase();
            displays.venue.innerText = venueVal;
            displays.cityState.innerText = (inputs.cityState.value || "CITY, STATE").toUpperCase();
            const noteVal = (inputs.note.value || "").toUpperCase();
            displays.note.innerText = noteVal;

            if (noteVal.trim() === "") {
                posterFooter.style.display = 'none';
                document.getElementById('poster-canvas').style.justifyContent = 'flex-start'; 
                document.getElementById('posterInfoWrapper').style.marginTop = 'auto';
                document.getElementById('posterInfoWrapper').style.marginBottom = 'auto';
                document.getElementById('posterHeader').classList.remove('mt-16');
            } else {
                posterFooter.style.display = 'block';
                document.getElementById('poster-canvas').style.justifyContent = 'space-between';
                document.getElementById('posterInfoWrapper').style.marginTop = '0';
                document.getElementById('posterInfoWrapper').style.marginBottom = '0';
                document.getElementById('posterHeader').classList.add('mt-16');
            }

            const t1 = (inputs.headerLine1.value || "FRANK").toUpperCase();
            const t2 = (inputs.headerLine2.value || "POWELL").toUpperCase();
            svgEls.line1.textContent = t1;
            svgEls.line2.textContent = t2;
            svgEls.tour.textContent = `${t1} ${t2}`;

            const scaleText = (text, baseSize, threshold) => text.length <= threshold ? baseSize : baseSize * (threshold / text.length);
            svgEls.line1.setAttribute('font-size', scaleText(t1, 110, 7));
            svgEls.line2.setAttribute('font-size', scaleText(t2, 110, 7));
            svgEls.tour.setAttribute('font-size', scaleText(`${t1} ${t2}`, 90, 12));
            const venueScale = (text, base, thresh) => text.length <= thresh ? base : Math.max(24, base * (thresh / text.length));
            displays.venue.style.fontSize = `${venueScale(venueVal, 60, 14)}px`;
        }

        function getExportFileName() {
            const clean = (str) => (str || "").replace(/[^a-zA-Z0-9\-_]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '').toUpperCase();
            
            if (currentTab === 'single') {
                const t1 = inputs.headerLine1.value || "FRANK";
                const t2 = inputs.headerLine2.value || "POWELL";
                const venue = inputs.venue.value || "VENUE";
                const date = inputs.date.value || "DATE";
                
                return `${clean(t1)}-${clean(t2)}-${clean(venue)}-${date}.png`;
            } else {
                const today = new Date().toISOString().split('T')[0];
                return `FRANK-POWELL-GIG-LIST-${today}.png`;
            }
        }

        function debouncedUpdate() { clearTimeout(debounceTimer); debounceTimer = setTimeout(updatePoster, 10); }

        function fitTourList() {
            const list = document.getElementById('tourCanvasList');
            const container = list.parentElement;
            let fontSize = 16; 
            list.style.fontSize = `${fontSize}px`;
            while (list.scrollHeight > container.clientHeight && fontSize > 8) {
                fontSize -= 0.5;
                list.style.fontSize = `${fontSize}px`;
            }
        }

        // --- 6. EXPORT & SHARE ---
        function generateICSContent() {
            const dates = window.currentTourData || [];
            if (!dates.length) return null;
            const pad = n => n.toString().padStart(2, '0');
            const formatICSDate = (date) => date.getFullYear() + pad(date.getMonth() + 1) + pad(date.getDate()) + 'T' + pad(date.getHours()) + pad(date.getMinutes()) + pad(date.getSeconds());
            const escapeICS = (str) => (str || '').replace(/\\/g, '\\\\').replace(/;/g, '\\;').replace(/,/g, '\\,').replace(/\n/g, '\\n');
            const now = new Date();
            const dtStamp = formatICSDate(now);
            let icsLines = ["BEGIN:VCALENDAR", "VERSION:2.0", "PRODID:-//Frank Powell//Gig Calendar//EN", "CALSCALE:GREGORIAN", "METHOD:PUBLISH"];

            dates.forEach((d, index) => {
                let startHour = 19; 
                if (d.time) {
                    const match = d.time.match(/^(\d+)/);
                    if (match) {
                        let h = parseInt(match[1], 10);
                        if (h < 12) h += 12; if (h === 24) h = 12; startHour = h;
                    }
                }
                const [y, m, day] = d.date.split('-').map(Number);
                const startDate = new Date(y, m - 1, day, startHour, 0, 0);
                const endDate = new Date(startDate.getTime() + 3 * 60 * 60 * 1000); 
                icsLines.push("BEGIN:VEVENT", `UID:cloud-${d.id || index}@frankpowell.net`, `DTSTAMP:${dtStamp}`, `DTSTART:${formatICSDate(startDate)}`, `DTEND:${formatICSDate(endDate)}`, `SUMMARY:${escapeICS("Frank Powell @ " + d.venue)}`, `LOCATION:${escapeICS(d.venue + ", " + d.city)}`, `DESCRIPTION:${escapeICS(d.note || "")}`, "STATUS:CONFIRMED", "END:VEVENT");
            });
            icsLines.push("END:VCALENDAR");
            return icsLines.join("\r\n");
        }

        function downloadCalendar() {
            const c = generateICSContent();
            if(!c) return alert("Empty.");
            const blob = new Blob([c], {type:'text/calendar;charset=utf-8'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = "Frank_Powell_Gigs.ics";
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        async function shareCalendar() {
            const c = generateICSContent();
            if(!c) return alert("Empty.");
            const file = new File([c], "Frank_Powell_Gigs.ics", {type:'text/plain'});
            if(navigator.share && navigator.canShare({files:[file]})) {
                try { await navigator.share({files:[file], title:'Gig Calendar'}); } catch(e) { if(e.name!=='AbortError') downloadCalendar(); }
            } else downloadCalendar();
        }

        function switchTab(t) {
            currentTab = t;
            document.getElementById('poster-canvas').classList.toggle('hidden', t !== 'single');
            document.getElementById('tour-canvas').classList.toggle('hidden', t !== 'tour');
            document.getElementById('tab-single').classList.toggle('active', t === 'single');
            document.getElementById('tab-tour').classList.toggle('active', t === 'tour');
            if(t === 'tour') setTimeout(fitTourList, 50); 
            scalePreview();
        }

        function scalePreview() {
            const w = document.getElementById('preview-scaler');
            const c = w.parentElement;
            const el = currentTab === 'single' ? document.getElementById('poster-canvas') : document.getElementById('tour-canvas');
            const scale = Math.min((c.clientWidth - 40)/1080, (c.clientHeight - 40)/1350);
            w.style.transform = `scale(${Math.min(scale, 1)})`;
        }

        async function createBlob() {
            const id = currentTab === 'single' ? 'poster-canvas' : 'tour-canvas';
            const el = document.getElementById(id);
            const box = document.createElement('div');
            Object.assign(box.style, {position:'fixed', top:'0', left:'0', width:'1080px', height:'1350px', zIndex:'-9999', opacity:'0'});
            document.body.appendChild(box);
            const clone = el.cloneNode(true);
            clone.classList.remove('hidden');
            Object.assign(clone.style, {transform:'none', width:'1080px', height:'1350px', margin:'0'});
            box.appendChild(clone);
            await document.fonts.ready;
            const canvas = await html2canvas(clone, {scale:2, useCORS:true, allowTaint:true, backgroundColor:null, windowWidth:1080, windowHeight:1350, width:1080, height:1350});
            document.body.removeChild(box);
            return new Promise(r => canvas.toBlob(r, 'image/png'));
        }

        async function downloadActivePoster() {
            const btn = document.querySelector('button[title="Download Poster Image"]');
            btn.disabled = true;
            try {
                const blob = await createBlob();
                const filename = getExportFileName();
                const a = document.createElement('a');
                a.download = filename;
                a.href = URL.createObjectURL(blob);
                a.click();
                URL.revokeObjectURL(a.href);
            } catch(e) { alert("Error: "+e.message); } finally { btn.disabled = false; }
        }

        async function shareActivePoster() {
            if(!navigator.share) return alert("Not supported");
            const btn = document.querySelector('button[title="Share Poster Image"]');
            btn.disabled = true;
            try {
                const blob = await createBlob();
                const filename = getExportFileName();
                const f = new File([blob], filename, {type:'image/png'});
                await navigator.share({title:'Gig Poster', files:[f]});
            } catch(e) { if(e.name!=='AbortError') alert(e.message); } finally { btn.disabled = false; }
        }

        Object.values(inputs).forEach(i => i.addEventListener('input', debouncedUpdate));
        window.addEventListener('resize', scalePreview);
        window.addEventListener('load', () => {
            initTimeOptions();
            loadVenues();
            const today = new Date().toISOString().split('T')[0];
            inputs.date.value = today;
            updatePoster(); 
            scalePreview();
        });
    </script>
</body>
</html>